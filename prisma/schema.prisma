generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String               @id
  clerkId          String               @unique
  name             String
  email            String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  certifications   Certification[]
  trainings        TrainingAttendance[]
  plannedTrainings PlannedTraining[]
  googleToken      GoogleToken?

  @@map("users")
}

model Certification {
  id              String               @id @default(cuid())
  certNumber      String               @unique
  userId          String
  acquisitionDate DateTime
  expirationDate  DateTime
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  user            User                 @relation(fields: [userId], references: [id])
  trainings       TrainingAttendance[]

  @@map("certifications")
}

model Training {
  id          String               @id @default(cuid())
  name        String
  category    Category?
  points      Int?
  date        DateTime
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  isOnline    Boolean              @default(false)
  attendances TrainingAttendance[]

  @@map("trainings")
}

model TrainingAttendance {
  id              String        @id @default(cuid())
  userId          String
  certificationId String
  trainingId      String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  certification   Certification @relation(fields: [certificationId], references: [id])
  training        Training      @relation(fields: [trainingId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@unique([userId, trainingId])
  @@map("training_attendances")
}

// 受講予定の研修（ノート機能）
model PlannedTraining {
  id                  String    @id @default(cuid())
  userId              String
  user                User      @relation(fields: [userId], references: [id])

  // 研修情報
  name                String    // 研修名
  category            Category? // 群（オプショナル）
  points              Int?      // ポイント数（オプショナル）
  applicationDeadline DateTime? // 申込期日
  paymentDeadline     DateTime? // 支払期日
  trainingDate        DateTime  // 研修日（必須）
  fee                 Int?      // 研修費（円）
  isOnline            Boolean   @default(false)
  memo                String?   // 備考

  // リマインダー設定
  remindApplication   Boolean   @default(true)
  remindPayment       Boolean   @default(true)
  remindTraining      Boolean   @default(true)

  // リマインダー送信済みフラグ
  reminderSentApplication Boolean @default(false)
  reminderSentPayment     Boolean @default(false)
  reminderSentTraining    Boolean @default(false)

  // Googleカレンダー連携状態
  calendarSynced      Boolean   @default(false)

  // 研修日過ぎフラグ（ログイン時にダイアログ表示用）
  hasPastTrainingDate Boolean   @default(false)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("planned_trainings")
}

// Googleカレンダー連携用トークン
model GoogleToken {
  id           String    @id @default(cuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id])
  accessToken  String
  refreshToken String
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("google_tokens")
}

enum Category {
  CATEGORY_A
  CATEGORY_B
  CATEGORY_C
  CATEGORY_D
  CATEGORY_E
  CATEGORY_F
}
